(library
 (public_name bitarray)
 (libraries base fmt base_quickcheck)
 (foreign_stubs
  (language c)
  (names bitarray_stubs)
  (flags :standard -O3 -march=native -Wall))
 (foreign_archives bitarray)
 (preprocess
  (pps ppx_jane))
 (inline_tests))

(rule
 (deps bitarray.ispc)
 (targets bitarray.o bitarray.h libbitarray.a)
 (action
  (progn
   (run ispc -g --pic -o bitarray.o -h bitarray.h --target avx512skx-i32x16 bitarray.ispc)
   (run ar -rcs libbitarray.a bitarray.o))))
